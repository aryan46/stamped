<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - CrowdSafe</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Icons -->
    <link href="https://unpkg.com/lucide-icons/dist/umd/lucide.js" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="brand">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-settings">
                <path
                    d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                <circle cx="12" cy="12" r="3" />
            </svg>
            System Administration
        </div>
        <div class="flex-center" style="gap: 15px;">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6" />
                </svg> Back to Dashboard
            </a>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
        </div>
    </nav>

    <div class="container animate-fade-in">

        <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem;">

            <!-- Add Camera Section -->
            <div class="glass-panel" style="padding: 2rem; align-self: start;">
                <h3 class="mb-4">Add New Camera Source</h3>
                <form id="addCamForm">
                    <div class="mb-4">
                        <label style="display: block; margin-bottom: 5px;">Source Type</label>
                        <select name="type" id="camType" class="form-control" onchange="updatePlaceholder()">
                            <option value="file">üìÇ Video File</option>
                            <option value="rtsp">üì± IP Camera / Mobile (RTSP)</option>
                            <option value="youtube">‚ñ∂Ô∏è YouTube URL</option>
                            <option value="webcam">üì∑ USB Webcam</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label style="display: block; margin-bottom: 5px;">Camera Label</label>
                        <input type="text" name="label" class="form-control"
                            placeholder="e.g. Main Gate, North Entrance" required>
                    </div>

                    <div class="mb-4">
                        <label id="sourceLabel" style="display: block; margin-bottom: 5px;">File Path / URL</label>
                        <input type="text" name="source" id="sourceInput" class="form-control"
                            placeholder="Enter source..." required>
                        <div id="helperText" style="font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;">
                            Enter filename from 'videos' folder (e.g. crowd6.mp4)
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10" />
                            <path d="M8 12h8" />
                            <path d="M12 8v8" />
                        </svg>
                        Add Camera
                    </button>
                </form>
            </div>

            <!-- Active Cameras List -->
            <div class="glass-panel" style="padding: 2rem;">
                <h3 class="mb-4">Active Cameras</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
                        <thead>
                            <tr style="text-align: left; color: var(--text-muted);">
                                <th style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Label</th>
                                <th style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Type/Source
                                </th>
                                <th style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Status</th>
                                <th style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cam_id, details in cameras.items() %}
                            <tr>
                                <td
                                    style="padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: 500;">
                                    {{ labels.get(cam_id, 'Unknown') }}
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">{{ cam_id }}</div>
                                </td>
                                <td
                                    style="padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: monospace; font-size: 0.9rem; color: var(--text-muted);">
                                    {{ details|truncate(40) }}
                                </td>
                                <td style="padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <span class="status-badge badge-safe">Active</span>
                                </td>
                                <td style="padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <button onclick="removeCamera('{{ cam_id }}')" class="btn btn-secondary"
                                        style="padding: 6px 12px; font-size: 0.85rem; color: var(--status-danger);">
                                        Remove
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" style="text-align:center; padding: 2rem; color: var(--text-muted);">
                                    No cameras active. Use the form to add one.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        function updatePlaceholder() {
            const type = document.getElementById('camType').value;
            const label = document.getElementById('sourceLabel');
            const input = document.getElementById('sourceInput');
            const helper = document.getElementById('helperText');

            if (type === 'file') {
                label.innerText = "Video Filename";
                input.placeholder = "crowd6.mp4";
                helper.innerText = "File must be in the 'videos' folder within the project.";
            } else if (type === 'rtsp') {
                label.innerText = "Stream URL (RTSP / HTTP)";
                input.placeholder = "http://192.168.1.5:8080/video";
                helper.innerText = "For Mobile: Use 'IP Webcam' app and enter the 'Video Renderer' URL here.";
            } else if (type === 'youtube') {
                label.innerText = "YouTube Video URL";
                input.placeholder = "https://www.youtube.com/watch?v=...";
                helper.innerText = "Standard YouTube link. Avoid live streams if possible for better stability.";
            } else if (type === 'webcam') {
                label.innerText = "Device Index";
                input.placeholder = "0";
                helper.innerText = "0 is usually the default laptop webcam. 1 is external.";
            }
        }

        document.getElementById('addCamForm').onsubmit = function (e) {
            e.preventDefault();
            const btn = this.querySelector('button[type="submit"]');
            const originalHTML = btn.innerHTML;
            btn.innerText = "Processing...";
            btn.disabled = true;

            const formData = new FormData(this);
            const data = {
                type: formData.get('type'),
                label: formData.get('label'),
                source: formData.get('source')
            };

            fetch('/add_camera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        location.reload();
                    } else {
                        alert('Error: ' + (data.message || 'Failed to add camera'));
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    alert('Connection error');
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                });
        }

        function removeCamera(camId) {
            if (!confirm('Are you sure you want to remove this camera?')) return;

            fetch('/remove_camera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: camId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') location.reload();
                    else alert('Error removing camera');
                });
        }
    </script>
</body>

</html>