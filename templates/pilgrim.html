<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temple Status - Live Updates</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link href="https://unpkg.com/lucide-icons/dist/umd/lucide.js" rel="stylesheet">
    <style>
        /* Pilgrim Specific Styles matching Neon Theme */
        :root {
            /* Inherit mostly from style.css, override specifics */
            --status-safe: #00f2ff;
            /* Cyan */
            --status-warning: #ffaa00;
            --status-danger: #ff0055;
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            /* Background set in style.css */
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .pilgrim-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Card Grid */
        .status-grid {
            display: grid;
            grid-template-columns: 1fr;
            /* Mobile First Stack */
            gap: 20px;
            margin-top: 20px;
        }

        @media(min-width: 600px) {
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        .status-card {
            background: rgba(2, 6, 23, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(12px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .status-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--status-safe), transparent);
            opacity: 0.5;
        }

        .status-card:active {
            transform: scale(0.98);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .zone-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            letter-spacing: 0.5px;
        }

        .status-badge-pill {
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 15px;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        /* Progress Bar */
        .density-bar-bg {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .density-bar-fill {
            height: 100%;
            background: var(--status-safe);
            width: 0%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px currentColor;
        }

        /* Main Banner */
        .main-status-banner {
            background: linear-gradient(180deg, rgba(2, 6, 23, 0.8) 0%, rgba(15, 23, 42, 0.4) 100%);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.5);
        }

        /* Mobile Map Height */
        #map {
            height: 350px;
            border-radius: 16px;
            width: 100%;
            border: 1px solid var(--glass-border);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 18px;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            font-family: 'Outfit', sans-serif;
        }

        .nav-btn:active {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>
    <!-- Simple Public Navbar -->
    <nav
        style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: rgba(0,0,0,0.2);">
        <div style="font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-book-open">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
            </svg>
            <span data-key="title">Temple Live Status</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="changeLanguage()" class="nav-btn" style="display: flex; align-items: center; gap: 5px;">
                üåê <span id="lang-btn-text">English</span>
            </button>
            <button onclick="document.getElementById('sosModal').style.display='flex'"
                style="background: var(--status-danger); border: none; padding: 8px 16px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
                üÜò <span data-key="sos">SOS</span>
            </button>
        </div>
    </nav>

    <div class="pilgrim-container">

        <!-- Main Status Banner -->
        <div class="main-status-banner" id="main-banner">
            <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                <button id="audio-btn" onclick="toggleAudio()"
                    style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;">
                    üîá <span data-key="enable_audio">Enable Audio Alerts</span>
                </button>
            </div>

            <p data-key="crowd_level_label"
                style="text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">
                Current Crowd Level</p>

            <h1 id="main-status-text" style="font-size: 3.5rem; margin-bottom: 20px; font-weight: 700;">Loading...</h1>

            <div id="main-status-badge"
                style="display: inline-block; padding: 10px 24px; border-radius: 30px; font-weight: bold; background: rgba(255,255,255,0.1); font-size: 1.1rem;">
                System Check
            </div>
        </div>

        <!-- Live Map -->
        <h2 data-key="map_title" class="mb-4" style="text-align: center; margin-bottom: 20px;">Live Safe Routes</h2>
        <div style="padding: 10px; margin-bottom: 40px; background: var(--glass-bg); border-radius: 16px;">
            <div id="map"></div>
            <div
                style="padding: 15px; text-align: center; font-size: 0.9rem; color: #94a3b8; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <div><span style="color: #2ecc71;">‚óè</span> <span data-key="legend_safe">Safe</span></div>
                <div><span style="color: #f1c40f;">‚óè</span> <span data-key="legend_slow">Crowded</span></div>
                <div><span style="color: #e74c3c;">‚óè</span> <span data-key="legend_avoid">Avoid / High Risk</span></div>
            </div>
        </div>

        <!-- Detailed Cards Grid -->
        <h2 data-key="queue_title" style="text-align: center; margin-bottom: 20px;">Queue & Zone Status</h2>
        <div id="status-list" class="status-grid">
            <!-- Populated via JS -->
            <!-- Loading Skeleton -->
            <div class="status-card"
                style="height: 200px; display: flex; align-items: center; justify-content: center;">Loading data...
            </div>
            <div class="status-card" style="height: 200px;"></div>
            <div class="status-card" style="height: 200px;"></div>
        </div>

        <div style="text-align: center; margin-top: 60px; color: #64748b; font-size: 0.8rem;">
            <p data-key="auto_update">Updates automatically every few seconds.</p>
            <p>&copy; 2026 CrowdSafe System</p>
        </div>

    </div>

    <!-- SOS Modal -->
    <div id="sosModal"
        style="display: none; position: fixed; inset: 0; z-index: 2000; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div
            style="background: #1e293b; width: 90%; max-width: 400px; padding: 2rem; text-align: center; border-radius: 20px; border: 1px solid var(--status-danger); box-shadow: 0 0 50px rgba(239, 68, 68, 0.2);">
            <h2 data-key="sos_title" style="color: var(--status-danger); margin-bottom: 25px; font-size: 1.5rem;">
                EMERGENCY CONTACTS</h2>

            <div style="display: grid; gap: 15px; margin-bottom: 25px;">
                <a href="tel:100" class="status-card"
                    style="display: flex; align-items: center; padding: 15px; text-decoration: none; color: white;">
                    <div style="font-size: 2rem; margin-right: 15px;">üëÆ</div>
                    <div style="text-align: left;">
                        <div style="font-weight: bold; font-size: 1.1rem;"><span data-key="police">Police Control</span>
                        </div>
                        <div style="color: #94a3b8;">Dial 100</div>
                    </div>
                </a>
                <a href="tel:108" class="status-card"
                    style="display: flex; align-items: center; padding: 15px; text-decoration: none; color: white;">
                    <div style="font-size: 2rem; margin-right: 15px;">üöë</div>
                    <div style="text-align: left;">
                        <div style="font-weight: bold; font-size: 1.1rem;"><span data-key="ambulance">Ambulance</span>
                        </div>
                        <div style="color: #94a3b8;">Dial 108</div>
                    </div>
                </a>
                <a href="tel:5551234" class="status-card"
                    style="display: flex; align-items: center; padding: 15px; text-decoration: none; color: white;">
                    <div style="font-size: 2rem; margin-right: 15px;">üìû</div>
                    <div style="text-align: left;">
                        <div style="font-weight: bold; font-size: 1.1rem;"><span data-key="temple_office">Temple
                                Office</span></div>
                        <div style="color: #94a3b8;">+91 555-1234</div>
                    </div>
                </a>
            </div>

            <button onclick="document.getElementById('sosModal').style.display='none'"
                style="width: 100%; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.1); color: white; border: none; font-weight: bold; cursor: pointer;">
                <span data-key="close">Close</span>
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // --- TRANSLATIONS (EN, HI, KN, TE) ---
        // kn = Kannada, te = Telugu
        const dictionary = {
            en: {
                title: "Temple Live Status",
                sos: "SOS",
                enable_audio: "Enable Audio Alerts",
                disable_audio: "Disable Audio",
                crowd_level_label: "Average Crowd Density",
                map_title: "Live Safe Routes",
                legend_safe: "Safe Areas",
                legend_slow: "Crowded",
                legend_avoid: "High Risk",
                queue_title: "Live Zone Status",
                auto_update: "Real-time updates active.",
                sos_title: "EMERGENCY CONTACTS",
                police: "Police Control",
                ambulance: "Ambulance",
                temple_office: "Temple Office",
                close: "Close",
                // Dynamic
                people: "People",
                risk: "Risk Level",
                alert_high: "HIGH CROWD ALERT",
                alert_moderate: "MODERATE CROWD",
                alert_normal: "NORMAL MOVEMENT",
                badge_wait: "Please Wait in Safe Zones",
                badge_slow: "Move Slowly",
                badge_open: "Venue Open",
                status_safe: "Safe",
                status_crowded: "Crowded",
                status_high: "High Risk",
                action_proceed: "Proceed",
                action_caution: "Proceed with Caution",
                action_stop: "Do Not Enter"
            },
            hi: {
                title: "‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§≤‡§æ‡§á‡§µ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø",
                sos: "‡§Æ‡§¶‡§¶",
                enable_audio: "‡§ë‡§°‡§ø‡§Ø‡•ã ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•á‡§Ç",
                disable_audio: "‡§ë‡§°‡§ø‡§Ø‡•ã ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
                crowd_level_label: "‡§î‡§∏‡§§ ‡§≠‡•Ä‡§°‡§º ‡§ò‡§®‡§§‡•ç‡§µ",
                map_title: "‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§Æ‡§æ‡§∞‡•ç‡§ó",
                legend_safe: "‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞",
                legend_slow: "‡§≠‡•Ä‡§°‡§º",
                legend_avoid: "‡§ñ‡§§‡§∞‡§æ",
                queue_title: "‡§≤‡§æ‡§á‡§µ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø",
                auto_update: "‡§∞‡•Ä‡§Ø‡§≤-‡§ü‡§æ‡§á‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§π‡•à‡•§",
                sos_title: "‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï",
                police: "‡§™‡•Å‡§≤‡§ø‡§∏ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£",
                ambulance: "‡§è‡§Æ‡•ç‡§¨‡•Å‡§≤‡•á‡§Ç‡§∏",
                temple_office: "‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø",
                close: "‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
                // Dynamic
                people: "‡§≤‡•ã‡§ó",
                risk: "‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§∏‡•ç‡§§‡§∞",
                alert_high: "‡§∏‡§æ‡§µ‡§ß‡§æ‡§®: ‡§Ö‡§§‡•ç‡§Ø‡§ß‡§ø‡§ï ‡§≠‡•Ä‡§°‡§º",
                alert_moderate: "‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§≠‡•Ä‡§°‡§º",
                alert_normal: "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ü‡§µ‡§æ‡§ó‡§Æ‡§®",
                badge_wait: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§∞‡•Å‡§ï‡•á‡§Ç",
                badge_slow: "‡§ß‡•Ä‡§∞‡•á ‡§ö‡§≤‡•á‡§Ç",
                badge_open: "‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à",
                status_safe: "‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§",
                status_crowded: "‡§≠‡•Ä‡§°‡§º",
                status_high: "‡§ñ‡§§‡§∞‡§æ",
                action_proceed: "‡§ú‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç",
                action_caution: "‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•Ä ‡§∏‡•á ‡§¨‡§¢‡§º‡•á‡§Ç",
                action_stop: "‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§® ‡§ï‡§∞‡•á‡§Ç"
            },
            kn: {
                title: "‡≤¶‡≥á‡≤µ‡≤æ‡≤≤‡≤Ø‡≤¶ ‡≤≤‡≥à‡≤µ‡≥ç ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø",
                sos: "‡≤∏‡≤π‡≤æ‡≤Ø",
                enable_audio: "‡≤∂‡≤¨‡≥ç‡≤¶ ‡≤é‡≤ö‡≥ç‡≤ö‡≤∞‡≤ø‡≤ï‡≥Ü ‡≤Ü‡≤®‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø",
                disable_audio: "‡≤∂‡≤¨‡≥ç‡≤¶ ‡≤é‡≤ö‡≥ç‡≤ö‡≤∞‡≤ø‡≤ï‡≥Ü ‡≤Ü‡≤´‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø",
                crowd_level_label: "‡≤™‡≥ç‡≤∞‡≤∏‡≥ç‡≤§‡≥Å‡≤§ ‡≤ú‡≤®‡≤¶‡≤ü‡≥ç‡≤ü‡≤£‡≥Ü",
                map_title: "‡≤∏‡≥Å‡≤∞‡≤ï‡≥ç‡≤∑‡≤ø‡≤§ ‡≤Æ‡≤æ‡≤∞‡≥ç‡≤ó‡≤ó‡≤≥‡≥Å",
                legend_safe: "‡≤∏‡≥Å‡≤∞‡≤ï‡≥ç‡≤∑‡≤ø‡≤§ ‡≤§‡≤æ‡≤£",
                legend_slow: "‡≤ú‡≤®‡≤¶‡≤ü‡≥ç‡≤ü‡≤£‡≥Ü",
                legend_avoid: "‡≤Ö‡≤™‡≤æ‡≤Ø",
                queue_title: "‡≤µ‡≤≤‡≤Ø ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø",
                auto_update: "‡≤®‡≥à‡≤ú ‡≤∏‡≤Æ‡≤Ø‡≤¶ ‡≤®‡≤µ‡≥Ä‡≤ï‡≤∞‡≤£‡≤ó‡≤≥‡≥Å.",
                sos_title: "‡≤§‡≥Å‡≤∞‡≥ç‡≤§‡≥Å ‡≤∏‡≤Ç‡≤™‡≤∞‡≥ç‡≤ï‡≤ó‡≤≥‡≥Å",
                police: "‡≤™‡≥ä‡≤≤‡≥Ä‡≤∏‡≥ç ‡≤®‡≤ø‡≤Ø‡≤Ç‡≤§‡≥ç‡≤∞‡≤£",
                ambulance: "‡≤Ü‡≤Ç‡≤¨‡≥ç‡≤Ø‡≥Å‡≤≤‡≥Ü‡≤®‡≥ç‡≤∏‡≥ç",
                temple_office: "‡≤¶‡≥á‡≤µ‡≤æ‡≤≤‡≤Ø ‡≤ï‡≤ö‡≥á‡≤∞‡≤ø",
                close: "‡≤Æ‡≥Å‡≤ö‡≥ç‡≤ö‡≤ø",
                // Dynamic
                people: "‡≤ú‡≤®‡≤∞‡≥Å",
                risk: "‡≤Ö‡≤™‡≤æ‡≤Ø‡≤¶ ‡≤Æ‡≤ü‡≥ç‡≤ü",
                alert_high: "‡≤é‡≤ö‡≥ç‡≤ö‡≤∞‡≤ø‡≤ï‡≥Ü: ‡≤π‡≥Ü‡≤ö‡≥ç‡≤ö‡≥Å ‡≤ú‡≤®‡≤¶‡≤ü‡≥ç‡≤ü‡≤£‡≥Ü",
                alert_moderate: "‡≤Æ‡≤ß‡≥ç‡≤Ø‡≤Æ ‡≤ú‡≤®‡≤¶‡≤ü‡≥ç‡≤ü‡≤£‡≥Ü",
                alert_normal: "‡≤∏‡≤æ‡≤Æ‡≤æ‡≤®‡≥ç‡≤Ø ‡≤∏‡≤Ç‡≤ö‡≤æ‡≤∞",
                badge_wait: "‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤∏‡≥Å‡≤∞‡≤ï‡≥ç‡≤∑‡≤ø‡≤§ ‡≤µ‡≤≤‡≤Ø‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø‡≤∞‡≤ø",
                badge_slow: "‡≤®‡≤ø‡≤ß‡≤æ‡≤®‡≤µ‡≤æ‡≤ó‡≤ø ‡≤∏‡≤æ‡≤ó‡≤ø",
                badge_open: "‡≤™‡≥ç‡≤∞‡≤µ‡≥á‡≤∂ ‡≤Æ‡≥Å‡≤ï‡≥ç‡≤§‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü",
                status_safe: "‡≤∏‡≥Å‡≤∞‡≤ï‡≥ç‡≤∑‡≤ø‡≤§",
                status_crowded: "‡≤ú‡≤®‡≤¶‡≤ü‡≥ç‡≤ü‡≤£‡≥Ü",
                status_high: "‡≤Ö‡≤™‡≤æ‡≤Ø",
                action_proceed: "‡≤Æ‡≥Å‡≤Ç‡≤¶‡≥Å‡≤µ‡≤∞‡≤ø‡≤Ø‡≤ø‡≤∞‡≤ø",
                action_caution: "‡≤é‡≤ö‡≥ç‡≤ö‡≤∞‡≤ø‡≤ï‡≥Ü‡≤Ø‡≤ø‡≤Ç‡≤¶ ‡≤∏‡≤æ‡≤ó‡≤ø",
                action_stop: "‡≤™‡≥ç‡≤∞‡≤µ‡≥á‡≤∂‡≤ø‡≤∏‡≤¨‡≥á‡≤°‡≤ø"
            },
            te: {
                title: "‡∞Ü‡∞≤‡∞Ø ‡∞≤‡±à‡∞µ‡±ç ‡∞∏‡±ç‡∞•‡∞ø‡∞§‡∞ø",
                sos: "‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç (SOS)",
                enable_audio: "‡∞Ü‡∞°‡∞ø‡∞Ø‡±ã ‡∞π‡±Ü‡∞ö‡±ç‡∞ö‡∞∞‡∞ø‡∞ï‡∞≤‡∞®‡±Å ‡∞Ü‡∞®‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
                disable_audio: "‡∞Ü‡∞°‡∞ø‡∞Ø‡±ã ‡∞Ü‡∞™‡±Å",
                crowd_level_label: "‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§ ‡∞∞‡∞¶‡±ç‡∞¶‡±Ä",
                map_title: "‡∞∏‡±Å‡∞∞‡∞ï‡±ç‡∞∑‡∞ø‡∞§ ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ó‡∞æ‡∞≤‡±Å",
                legend_safe: "‡∞∏‡±Å‡∞∞‡∞ï‡±ç‡∞∑‡∞ø‡∞§ ‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞Ç",
                legend_slow: "‡∞∞‡∞¶‡±ç‡∞¶‡±Ä‡∞ó‡∞æ ‡∞â‡∞Ç‡∞¶‡∞ø",
                legend_avoid: "‡∞™‡±ç‡∞∞‡∞Æ‡∞æ‡∞¶‡∞Ç",
                queue_title: "‡∞ú‡±ã‡∞®‡±ç ‡∞∏‡±ç‡∞•‡∞ø‡∞§‡∞ø",
                auto_update: "‡∞∞‡∞ø‡∞Ø‡∞≤‡±ç ‡∞ü‡±à‡∞Æ‡±ç ‡∞Ö‡∞™‡±ç‚Äå‡∞°‡±á‡∞ü‡±ç‡∞∏‡±ç.",
                sos_title: "‡∞Ö‡∞§‡±ç‡∞Ø‡∞µ‡∞∏‡∞∞ ‡∞™‡∞∞‡∞ø‡∞ö‡∞Ø‡∞æ‡∞≤‡±Å",
                police: "‡∞™‡±ã‡∞≤‡±Ä‡∞∏‡±ç ‡∞ï‡∞Ç‡∞ü‡±ç‡∞∞‡±ã‡∞≤‡±ç",
                ambulance: "‡∞Ö‡∞Ç‡∞¨‡±Å‡∞≤‡±Ü‡∞®‡±ç‡∞∏‡±ç",
                temple_office: "‡∞Ü‡∞≤‡∞Ø ‡∞ï‡∞æ‡∞∞‡±ç‡∞Ø‡∞æ‡∞≤‡∞Ø‡∞Ç",
                close: "‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞ø",
                // Dynamic
                people: "‡∞™‡±ç‡∞∞‡∞ú‡∞≤‡±Å",
                risk: "‡∞™‡±ç‡∞∞‡∞Æ‡∞æ‡∞¶ ‡∞∏‡±ç‡∞•‡∞æ‡∞Ø‡∞ø",
                alert_high: "‡∞π‡±Ü‡∞ö‡±ç‡∞ö‡∞∞‡∞ø‡∞ï: ‡∞Ö‡∞ß‡∞ø‡∞ï ‡∞∞‡∞¶‡±ç‡∞¶‡±Ä",
                alert_moderate: "‡∞Æ‡∞ø‡∞§‡∞Æ‡±à‡∞® ‡∞∞‡∞¶‡±ç‡∞¶‡±Ä",
                alert_normal: "‡∞∏‡∞æ‡∞ß‡∞æ‡∞∞‡∞£ ‡∞ï‡∞¶‡∞≤‡∞ø‡∞ï",
                badge_wait: "‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞µ‡±á‡∞ö‡∞ø ‡∞â‡∞Ç‡∞°‡∞Ç‡∞°‡∞ø",
                badge_slow: "‡∞®‡±Ü‡∞Æ‡±ç‡∞Æ‡∞¶‡∞ø‡∞ó‡∞æ ‡∞µ‡±Ü‡∞≥‡±ç‡∞≥‡∞Ç‡∞°‡∞ø",
                badge_open: "‡∞™‡±ç‡∞∞‡∞µ‡±á‡∞∂‡∞Ç ‡∞§‡±Ü‡∞∞‡∞µ‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø",
                status_safe: "‡∞∏‡±Å‡∞∞‡∞ï‡±ç‡∞∑‡∞ø‡∞§‡∞Ç",
                status_crowded: "‡∞∞‡∞¶‡±ç‡∞¶‡±Ä",
                status_high: "‡∞™‡±ç‡∞∞‡∞Æ‡∞æ‡∞¶‡∞Ç",
                action_proceed: "‡∞µ‡±Ü‡∞≥‡±ç‡∞≥‡∞µ‡∞ö‡±ç‡∞ö‡±Å",
                action_caution: "‡∞ú‡∞æ‡∞ó‡±ç‡∞∞‡∞§‡±ç‡∞§‡∞ó‡∞æ ‡∞µ‡±Ü‡∞≥‡±ç‡∞≥‡∞Ç‡∞°‡∞ø",
                action_stop: "‡∞™‡±ç‡∞∞‡∞µ‡±á‡∞∂‡∞ø‡∞Ç‡∞ö‡∞µ‡∞¶‡±ç‡∞¶‡±Å"
            }
        };

        const languages = ['en', 'hi', 'kn', 'te'];
        const langNames = { 'en': 'English', 'hi': '‡§π‡§ø‡§Ç‡§¶‡•Ä', 'kn': '‡≤ï‡≤®‡≥ç‡≤®‡≤°', 'te': '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å' };
        let currentLangIndex = 0;
        let currentLang = 'en';
        let audioEnabled = false;
        let lastAudioTime = 0;

        function changeLanguage() {
            currentLangIndex = (currentLangIndex + 1) % languages.length;
            currentLang = languages[currentLangIndex];
            document.getElementById('lang-btn-text').innerText = langNames[currentLang];
            applyTranslations();
            updateStatus(); // Re-render dynamic content
        }

        function applyTranslations() {
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (dictionary[currentLang][key]) {
                    el.innerText = dictionary[currentLang][key];
                }
            });
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            const btn = document.getElementById('audio-btn');
            const key = audioEnabled ? 'disable_audio' : 'enable_audio';
            btn.innerHTML = (audioEnabled ? 'üîä ' : 'üîá ') + `<span data-key="${key}">${dictionary[currentLang][key]}</span>`;

            // Announce in current language
            announceAlert(dictionary[currentLang]['enable_audio'] || "Audio alerts enabled");
        }

        function announceAlert(text) {
            if (!window.speechSynthesis) return;
            // Debouncing is handled in logic, here we just speak if called
            const utter = new SpeechSynthesisUtterance(text);
            // Attempt to match lang code
            const langMap = { 'en': 'en-US', 'hi': 'hi-IN', 'kn': 'kn-IN', 'te': 'te-IN' };
            utter.lang = langMap[currentLang] || 'en-US';
            window.speechSynthesis.speak(utter);
        }

        // --- Map Initialization ---
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([12.9716, 77.5946], 18);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 20,
        }).addTo(map);

        // Zones Configuration
        const zones = {};

        function createZone(lat, lng, radius) {
            return L.circle([lat, lng], {
                radius: radius,
                color: "#999",
                fillColor: "#999",
                fillOpacity: 0.4,
                weight: 2
            }).addTo(map);
        }

        zones.gate1 = createZone(12.9719, 77.5946, 25);
        zones.gate2 = createZone(12.9722, 77.5950, 25);
        zones.gate3 = createZone(12.9714, 77.5953, 25);
        zones.darshan = createZone(12.9718, 77.5949, 35);

        // Safe Points (Always visible)
        L.circle([12.9725, 77.5940], { radius: 15, color: "#3498db", fillColor: "#3498db", fillOpacity: 0.8 }).addTo(map);
        L.circle([12.9710, 77.5940], { radius: 15, color: "#3498db", fillColor: "#3498db", fillOpacity: 0.8 }).addTo(map);

        const zoneToCamera = {
            gate1: "zone_gate1_queue",
            gate2: "zone_gate2_queue",
            gate3: "zone_outer_waiting",
            darshan: "zone_darshan_hall"
        };

        const cameraToFriendlyName = {
            "zone_gate1_queue": { en: "Main Gate Queue", hi: "‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¶‡•ç‡§µ‡§æ‡§∞ ‡§ï‡§§‡§æ‡§∞", kn: "‡≤Æ‡≥Å‡≤ñ‡≥ç‡≤Ø ‡≤¶‡≥ç‡≤µ‡≤æ‡≤∞‡≤¶ ‡≤∏‡≤æ‡≤≤‡≥Å", te: "‡∞™‡±ç‡∞∞‡∞ß‡∞æ‡∞® ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞Ç ‡∞ï‡±ç‡∞Ø‡±Ç" },
            "zone_gate2_queue": { en: "Side Entrance Queue", hi: "‡§∏‡§æ‡§á‡§° ‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§ï‡§§‡§æ‡§∞", kn: "‡≤™‡≤æ‡≤∞‡≥ç‡≤∂‡≥ç‡≤µ ‡≤™‡≥ç‡≤∞‡≤µ‡≥á‡≤∂ ‡≤∏‡≤æ‡≤≤‡≥Å", te: "‡∞∏‡±à‡∞°‡±ç ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡∞®‡±ç‡∞∏‡±ç ‡∞ï‡±ç‡∞Ø‡±Ç" },
            "zone_outer_waiting": { en: "Outer Waiting Area", hi: "‡§¨‡§æ‡§π‡§∞‡•Ä ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞", kn: "‡≤π‡≥ä‡≤∞‡≤ó‡≤ø‡≤® ‡≤ï‡≤æ‡≤Ø‡≥Å‡≤µ ‡≤™‡≥ç‡≤∞‡≤¶‡≥á‡≤∂", te: "‡∞¨‡∞Ø‡∞ü‡∞ø ‡∞®‡∞ø‡∞∞‡±Ä‡∞ï‡±ç‡∞∑‡∞£ ‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞Ç" },
            "zone_darshan_hall": { en: "Darshan Hall", hi: "‡§¶‡§∞‡•ç‡§∂‡§® ‡§π‡•â‡§≤", kn: "‡≤¶‡≤∞‡≥ç‡≤∂‡≤® ‡≤π‡≤æ‡≤≤‡≥ç", te: "‡∞¶‡∞∞‡±ç‡∞∂‡∞® ‡∞π‡∞æ‡∞≤‡±ç" },
            "zone_flow_corridor": { en: "Exit Flow", hi: "‡§®‡§ø‡§ï‡§æ‡§∏ ‡§Æ‡§æ‡§∞‡•ç‡§ó", kn: "‡≤¨‡≤π‡≤ø‡≤∞‡≤Ç‡≤ó ‡≤ú‡≤æ‡≤ó", te: "‡∞®‡∞ø‡∞∑‡±ç‡∞ï‡±ç‡∞∞‡∞Æ‡∞£ ‡∞™‡±ç‡∞∞‡∞µ‡∞æ‡∞π‡∞Ç" }
        };

        // --- Data Fetching ---
        function updateStatus() {
            fetch('/api/public_status')
                .then(res => res.json())
                .then(data => {
                    const listContainer = document.getElementById('status-list');
                    let listHTML = '';
                    let highestRiskVal = 0; // 0=Safe, 1=Crowded, 2=High
                    let strings = dictionary[currentLang];

                    // Update Zones on Map & Prepare Cards
                    for (const [camId, info] of Object.entries(data)) {
                        // Find which zone this is (for map)
                        let zoneName = Object.keys(zoneToCamera).find(key => zoneToCamera[key] === camId);

                        let color = '#10B981'; // Green
                        let statusText = strings.status_safe;
                        let statusBg = "rgba(16, 185, 129, 0.2)";
                        let icon = "shield-check";

                        // Parse numbers if they are strings or missing
                        let count = info.person_count || 0;
                        let risk = info.risk_score || 0.0;

                        if (info.situation.includes('High') || info.situation.includes('Stampede')) {
                            color = '#EF4444'; // Red
                            highestRiskVal = 2;
                            statusText = strings.status_high;
                            statusBg = "rgba(239, 68, 68, 0.2)";
                            icon = "alert-triangle";
                        } else if (info.situation.includes('Crowded')) {
                            color = '#F59E0B'; // Yellow
                            if (highestRiskVal < 1) highestRiskVal = 1;
                            statusText = strings.status_crowded;
                            statusBg = "rgba(245, 158, 11, 0.2)";
                            icon = "users";
                        }

                        // Update Map
                        if (zoneName && zones[zoneName]) {
                            zones[zoneName].setStyle({ fillColor: color, color: color });
                        }

                        // Generate Card HTML
                        const niceNameObj = cameraToFriendlyName[camId];
                        const niceName = (niceNameObj && niceNameObj[currentLang]) ? niceNameObj[currentLang] : (niceNameObj ? niceNameObj['en'] : camId);

                        // Calculate bar width (max assumed 100 people for demo scaling)
                        let barWidth = Math.min((count / 150) * 100, 100);

                        listHTML += `
                            <div class="status-card">
                                <div class="card-header">
                                    <div class="zone-title">${niceName}</div>
                                    <div class="status-badge-pill" style="background: ${statusBg}; color: ${color};">
                                        ${statusText}
                                    </div>
                                </div>
                                <div class="stat-row">
                                    <div><span style="font-size:1.2rem;">üë•</span> ${count} ${strings.people}</div>
                                    <div>‚ö†Ô∏è ${strings.risk}: ${(risk * 100).toFixed(0)}%</div>
                                </div>
                                <div style="font-size: 0.85rem; margin-bottom: 5px; color: #94a3b8;">${strings.crowd_level_label}</div>
                                <div class="density-bar-bg">
                                    <div class="density-bar-fill" style="width: ${barWidth}%; background: ${color};"></div>
                                </div>
                                <div style="margin-top: 15px; font-size: 0.85rem; color: #cbd5e1; display: flex; align-items: center;">
                                    ${info.situation.includes('Safe') ? '‚úÖ ' + strings.action_proceed : 'üõë ' + strings.action_stop}
                                </div>
                            </div>
                        `;
                    }

                    if (listHTML === '') {
                        listHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ccc;">No active cameras connected.</div>';
                    }

                    listContainer.innerHTML = listHTML;

                    // Update Main Banner
                    const mainTitle = document.getElementById('main-status-text');
                    const mainBadge = document.getElementById('main-status-badge');
                    const banner = document.getElementById('main-banner');

                    if (highestRiskVal === 2) {
                        mainTitle.innerText = strings.alert_high;
                        mainTitle.style.color = "#EF4444";
                        mainBadge.innerText = strings.badge_wait;
                        mainBadge.style.background = "rgba(239, 68, 68, 0.2)";
                        mainBadge.style.color = "#fca5a5";
                        banner.style.border = "1px solid #EF4444";

                        if (audioEnabled) {
                            announceAlert(strings.alert_high + ". " + strings.badge_wait);
                        }
                    } else if (highestRiskVal === 1) {
                        mainTitle.innerText = strings.alert_moderate;
                        mainTitle.style.color = "#F59E0B";
                        mainBadge.innerText = strings.badge_slow;
                        mainBadge.style.background = "rgba(245, 158, 11, 0.2)";
                        mainBadge.style.color = "#fcd34d";
                        banner.style.border = "1px solid #F59E0B";
                    } else {
                        mainTitle.innerText = strings.alert_normal;
                        mainTitle.style.color = "#10B981";
                        mainBadge.innerText = strings.badge_open;
                        mainBadge.style.background = "rgba(16, 185, 129, 0.2)";
                        mainBadge.style.color = "#6ee7b7";
                        banner.style.border = "1px solid #10B981";
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('status-list').innerHTML = '<div style="text-align:center;">Failed to connect to server.</div>';
                });
        }

        setInterval(updateStatus, 3000);
        updateStatus();

    </script>
</body>

</html>