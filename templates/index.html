<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ venue_name }} - Control Center</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Icons -->
    <link href="https://unpkg.com/lucide-icons/dist/umd/lucide.js" rel="stylesheet">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="brand">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-shield-alert">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />
                <path d="M12 8v4" />
                <path d="M12 16h.01" />
            </svg>
            {{ venue_name }} Monitor
        </div>
        <div class="flex-center" style="gap: 15px;">
            <div id="audio-permission">
                <button id="enable-audio-btn" class="btn btn-secondary">
                    üîî Enable Alerts
                </button>
            </div>
            <button onclick="window.location.href='{{ url_for('admin_panel') }}'" class="btn btn-secondary">
                ‚öôÔ∏è Admin
            </button>
            <button onclick="window.open('{{ url_for('pilgrim_page') }}', '_blank')" class="btn btn-primary">
                View Site
            </button>
        </div>
    </nav>

    <div class="container animate-fade-in">

        <!-- Stats Grid -->
        <h2 class="mb-4 text-neon">System Overview</h2>
        <div class="stats-grid">
            <!-- Crowd Density Card -->
            <div class="stat-card glass-panel" id="crowd-density-bar">
                <div class="stat-header">
                    <span>Crowd Density</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-neon">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                </div>
                <div class="dataslot" id="crowd-density-slot">...</div>
                <div class="stat-info">Peak zone density</div>
            </div>

            <!-- Active Alerts Card -->
            <div class="stat-card glass-panel" id="active-alerts-bar">
                <div class="stat-header">
                    <span>Active Alerts</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-alert">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
                        <path d="M12 9v4" />
                        <path d="M12 17h.01" />
                    </svg>
                </div>
                <div class="dataslot" id="active-alerts-slot">...</div>
                <div class="stat-info">Stampedes detected</div>
            </div>

            <!-- Critical Zones Card -->
            <div class="stat-card glass-panel" id="critical-zones-bar">
                <div class="stat-header">
                    <span>Critical Zones</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="color: var(--warning-neon);">
                        <path
                            d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z" />
                    </svg>
                </div>
                <div class="dataslot" id="critical-zones-slot">...</div>
                <div class="stat-info">High risk areas</div>
            </div>

            <!-- Monitoring Zones Card -->
            <div class="stat-card glass-panel">
                <div class="stat-header">
                    <span>Active Cameras</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                </div>
                <div class="dataslot" id="monitoring-zones-slot">...</div>
                <div class="stat-info">Total video feeds</div>
            </div>
        </div>

        <!-- Camera Feeds -->
        <div class="flex-between mb-4">
            <h2 class="text-neon">Live Feeds</h2>
        </div>

        <div class="camera-grid">
            {% for cam_id in camera_ids %}
            <div class="camera-card glass-panel">
                <div class="video-container">
                    <img src="{{ url_for('video_feed', camera_id=cam_id) }}?t={{ timestamp }}"
                        alt="Live Feed for {{ cam_id }}" class="video-feed">
                    <div class="status-badge"
                        style="position: absolute; top: 10px; right: 10px; background: rgba(255,0,0,0.8); color: white; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; animation: pulse-border 1s infinite;">
                        üî¥ REC</div>
                    <div
                        style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 4px; font-family: monospace; font-size: 0.7rem; color: #00f2ff;">
                        CAM: {{ cam_id }}
                    </div>
                </div>
                <div class="camera-info" id="status-box-{{ cam_id }}">
                    <div style="margin-bottom: 5px;"><strong>Location:</strong> <span
                            style="color: var(--text-muted);">Loading...</span></div>
                    <div><strong>Status:</strong> <span style="color: var(--text-muted);">Loading...</span></div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Emergency Panel -->
        <div class="emergency-info glass-panel" id="emergency-panel"
            style="border-color: var(--alert-neon); background: rgba(255, 0, 85, 0.1);">
            <h3 style="color: var(--alert-neon); margin-bottom: 10px;">‚ö†Ô∏è EMERGENCY PROTOCOL ACTIVATED ‚ö†Ô∏è</h3>
            <p>Follow enhanced routes on the map below. Proceed to Safe Assembly Points.</p>
        </div>

        <!-- Map Section -->
        <div class="flex-between mb-4 mt-5">
            <h2 class="text-neon">Live Safety Map</h2>
            <button id="show-routes-btn" onclick="toggleSafeRoutes()" class="btn btn-primary">
                üõ§Ô∏è Show Safe Routes
            </button>
        </div>

        <div class="map-container glass-panel">
            <div id="map"></div>
        </div>

        <div class="glass-panel mt-4 p-4 text-center">
            <h4 class="mb-3">Zone Status Legend</h4>
            <div class="flex-center" style="gap: 20px; flex-wrap: wrap;">
                <div class="flex-center"><span
                        style="width: 10px; height: 10px; background: #00f2ff; border-radius: 50%; box-shadow: 0 0 10px #00f2ff; margin-right: 8px;"></span>
                    Safe</div>
                <div class="flex-center"><span
                        style="width: 10px; height: 10px; background: #ffaa00; border-radius: 50%; margin-right: 8px;"></span>
                    Crowded</div>
                <div class="flex-center"><span
                        style="width: 10px; height: 10px; background: #ff5e00; border-radius: 50%; margin-right: 8px;"></span>
                    High Risk</div>
                <div class="flex-center"><span
                        style="width: 10px; height: 10px; background: #ff0055; border-radius: 50%; box-shadow: 0 0 10px #ff0055; margin-right: 8px;"></span>
                    Stampede</div>
            </div>
        </div>

    </div>

    <!-- Add Camera Modal (Hidden for now as in original) -->
    <div id="addCamModal"
        style="display:none; position: fixed; inset: 0; z-index: 2000; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center;">
        <div class="glass-panel" style="width: 100%; max-width: 500px; padding: 2rem;">
            <h3 class="mb-4">Add New Camera</h3>
            <form id="addCamForm">
                <div class="mb-4">
                    <label style="display: block; margin-bottom: 5px;">Camera Type</label>
                    <select name="type" id="camType" class="form-control" onchange="updatePlaceholder()">
                        <option value="file">Video File</option>
                        <option value="webcam">Webcam / USB</option>
                        <option value="rtsp">IP Camera / Mobile (RTSP)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label style="display: block; margin-bottom: 5px;">Label</label>
                    <input type="text" name="label" class="form-control" placeholder="e.g. Main Gate" required>
                </div>
                <div class="mb-4">
                    <label id="sourceLabel" style="display: block; margin-bottom: 5px;">File Name</label>
                    <input type="text" name="source" id="sourceInput" class="form-control" placeholder="crowd6.mp4"
                        required>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" onclick="document.getElementById('addCamModal').style.display='none'"
                        class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Camera</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Placeholder helper
        function updatePlaceholder() {
            const type = document.getElementById('camType').value;
            const label = document.getElementById('sourceLabel');
            const input = document.getElementById('sourceInput');
            if (type === 'file') {
                label.innerText = "File Name (in videos folder)";
                input.placeholder = "crowd6.mp4";
            } else if (type === 'webcam') {
                label.innerText = "Device Index";
                input.placeholder = "0";
            } else {
                label.innerText = "Stream URL";
                input.placeholder = "rtsp://... or http://... ";
            }
        }

        // Add Camera Logic
        document.getElementById('addCamForm').onsubmit = function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = {
                type: formData.get('type'),
                label: formData.get('label'),
                source: formData.get('source')
            };

            fetch('/add_camera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        location.reload();
                    } else {
                        alert('Error adding camera');
                    }
                })
                .catch(err => alert('Failed to add camera'));
        };

        // Main Dashboard Scripts
        document.addEventListener('DOMContentLoaded', function () {
            let safeRoutes = [];
            let safeRoutesVisible = false;

            const alertSound = new Audio("{{ url_for('static', filename='alert.mp3') }}");
            alertSound.loop = true;
            let isAlertActive = false;
            let audioEnabled = false;

            const enableAudioBtn = document.getElementById('enable-audio-btn');
            enableAudioBtn.addEventListener('click', function () {
                alertSound.play().then(() => {
                    audioEnabled = true;
                    alertSound.pause();
                    alertSound.currentTime = 0;
                    enableAudioBtn.textContent = 'üîä Alerts Active';
                    enableAudioBtn.style.color = 'var(--status-safe)';
                    enableAudioBtn.style.borderColor = 'var(--status-safe)';
                }).catch(error => {
                    alert('Please allow audio autoplay in your browser settings');
                    console.log("Audio permission denied");
                });
            });

            // ================= MAP INIT =================
            const map = L.map('map', {
                zoomControl: true,
                attributionControl: true
            }).setView([12.9716, 77.5946], 18);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 20,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Define temple zones with enhanced styling and labels
            const zones = {};
            // Create custom div icon for labels
            function createLabelIcon(text, className = 'zone-label') {
                return L.divIcon({
                    className: className,
                    html: text,
                    iconSize: [80, 30],
                    iconAnchor: [40, 15]
                });
            }

            // Gate 1 - Main Entrance
            zones.gate1 = L.circle([12.9719, 77.5946], {
                radius: 25,
                color: "#2ecc71",
                fillColor: "#2ecc71",
                fillOpacity: 0.6,
                weight: 3
            }).addTo(map);

            L.marker([12.9719, 77.5946], { icon: createLabelIcon('Gate 1<br>Main Entry') }).addTo(map);

            // Gate 2 - Side Entrance
            zones.gate2 = L.circle([12.9722, 77.5950], {
                radius: 25,
                color: "#2ecc71",
                fillColor: "#2ecc71",
                fillOpacity: 0.6,
                weight: 3
            }).addTo(map);

            L.marker([12.9722, 77.5950], { icon: createLabelIcon('Gate 2<br>Side Entry') }).addTo(map);

            // Gate 3 - Outer Queue
            zones.gate3 = L.circle([12.9714, 77.5953], {
                radius: 25,
                color: "#2ecc71",
                fillColor: "#2ecc71",
                fillOpacity: 0.6,
                weight: 3
            }).addTo(map);
            L.marker([12.9714, 77.5953], { icon: createLabelIcon('Gate 3<br>Outer Queue') }).addTo(map);

            // Darshan Hall - Main Temple Area
            zones.darshan = L.circle([12.9718, 77.5949], {
                radius: 35,
                color: "#2ecc71",
                fillColor: "#2ecc71",
                fillOpacity: 0.6,
                weight: 3
            }).addTo(map);
            L.marker([12.9718, 77.5949], { icon: createLabelIcon('Darshan Hall<br>Main Temple') }).addTo(map);

            // Safe Assembly Points
            const safePoints = [
                L.circle([12.9725, 77.5940], { radius: 15, color: "#3498db", fillColor: "#3498db", fillOpacity: 0.8, weight: 3 }).addTo(map),
                L.circle([12.9710, 77.5940], { radius: 15, color: "#3498db", fillColor: "#3498db", fillOpacity: 0.8, weight: 3 }).addTo(map)
            ];

            // Add labels for safe points
            L.marker([12.9725, 77.5940], { icon: createLabelIcon('Safe Point A') }).addTo(map);
            L.marker([12.9710, 77.5940], { icon: createLabelIcon('Safe Point B') }).addTo(map);

            const zoneToCamera = {
                gate1: "zone_gate1_queue",
                gate2: "zone_gate2_queue",
                gate3: "zone_outer_waiting",
                darshan: "zone_darshan_hall"
            };

            // Enhanced popup content
            function createPopupContent(zoneName, cameraId) {
                return `
                    <div style="text-align: center; padding: 5px;">
                        <h4 style="margin: 5px 0; color: #333;">${zoneName}</h4>
                        <p style="margin: 5px 0; font-size: 12px;">Camera: ${cameraId}</p>
                        <div id="popup-status-${zoneName}" style="font-weight: bold; margin: 5px 0;">Loading...</div>
                    </div>
                `;
            }

            zones.gate1.bindPopup(createPopupContent('Gate 1 - Main Entrance', 'temple_queue_cam1'));
            zones.gate2.bindPopup(createPopupContent('Gate 2 - Side Entrance', 'temple_queue_cam2'));
            zones.gate3.bindPopup(createPopupContent('Gate 3 - Outer Queue', 'temple_outer_queue1'));
            zones.darshan.bindPopup(createPopupContent('Darshan Hall', 'temple_darshan_zone1'));

            // Safe route definitions
            function createSafeRoutes() {
                safeRoutes.forEach(route => map.removeLayer(route));
                safeRoutes = [];

                const routeData = [
                    [[12.9719, 77.5946], [12.9722, 77.5943], [12.9725, 77.5940]],
                    [[12.9722, 77.5950], [12.9724, 77.5945], [12.9725, 77.5940]],
                    [[12.9714, 77.5953], [12.9712, 77.5948], [12.9710, 77.5940]],
                    [[12.9718, 77.5949], [12.9716, 77.5945], [12.9710, 77.5940]]
                ];

                routeData.forEach(points => {
                    const route = L.polyline(points, {
                        color: '#2ecc71',
                        weight: 6,
                        opacity: 0.8,
                        className: 'safe-route'
                    }).addTo(map);
                    safeRoutes.push(route);
                });

                L.marker([12.9721, 77.5943], {
                    icon: L.divIcon({
                        className: 'route-label',
                        html: '‚Üí Safe Exit',
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                }).addTo(map);
            }

            window.toggleSafeRoutes = function () {
                if (safeRoutesVisible) {
                    safeRoutes.forEach(route => map.removeLayer(route));
                    document.getElementById('show-routes-btn').textContent = 'üõ§Ô∏è Show Safe Routes';
                    safeRoutesVisible = false;
                } else {
                    createSafeRoutes();
                    document.getElementById('show-routes-btn').textContent = '‚ùå Hide Routes';
                    safeRoutesVisible = true;
                }
            };

            function setZoneColor(zoneLayer, zoneName, situation) {
                let pulseEffect = false;
                let color;
                situation = situation.trim().toLowerCase();

                switch (situation) {
                    case 'safe': color = '#2ecc71'; break;
                    case 'crowded': color = '#f1c40f'; break;
                    case 'high risk of stampede': color = '#e67e22'; pulseEffect = true; break;
                    case 'stampede in progress': color = '#e74c3c'; pulseEffect = true; break;
                    default: color = '#95a5a6';
                }

                zoneLayer.setStyle({
                    fillColor: color,
                    color: pulseEffect ? '#000' : color,
                    weight: pulseEffect ? 4 : 3,
                    fillOpacity: pulseEffect ? 0.8 : 0.6,
                    className: pulseEffect ? 'pulsing-zone' : ''
                });

                const popupContent = document.getElementById(`popup-status-${zoneName}`);
                if (popupContent) {
                    popupContent.innerHTML = `Status: <span style="color: ${color};">${situation}</span>`;
                }
            }

            // ================= STATUS UPDATE LOGIC =================
            function updateAllStatuses() {
                fetch('/status/all')
                    .then(response => response.json())
                    .then(all_data => {
                        let activeAlerts = 0;
                        let criticalZones = 0;
                        const monitoringZones = Object.keys(all_data).length;
                        let isHighRiskPresent = false;
                        let crowdedCount = 0;

                        for (const cam_id in all_data) {
                            if (all_data.hasOwnProperty(cam_id)) {
                                const data = all_data[cam_id];
                                const statusBox = document.getElementById(`status-box-${cam_id}`);
                                const situation = data.situation || 'N/A';

                                if (situation === 'Stampede in Progress') {
                                    activeAlerts++;
                                    isHighRiskPresent = true;
                                } else if (situation === 'High Risk of Stampede') {
                                    criticalZones++;
                                    isHighRiskPresent = true;
                                } else if (situation === 'Crowded') {
                                    crowdedCount++;
                                }

                                if (statusBox) {
                                    let situationClass = 'status-safe';
                                    if (situation.includes('Stampede')) situationClass = 'status-stampede';
                                    else if (situation.includes('High Risk')) situationClass = 'status-risk';
                                    else if (situation.includes('Crowded')) situationClass = 'status-crowded';

                                    statusBox.innerHTML = `<div style="margin-bottom: 5px;"><strong>Location:</strong> <span style="color: white;">${data.location}</span></div>
                                                           <div><strong>Situation:</strong> <span class="${situationClass}">${situation}</span></div>`;
                                }
                            }
                        }

                        // --- FETCH ANALYTICS (PREDICTIONS) ---
                        fetch('/api/analytics')
                            .then(res => res.json())
                            .then(analytics_data => {
                                for (const cam_id in analytics_data) {
                                    const pred = analytics_data[cam_id];
                                    const statusBox = document.getElementById(`status-box-${cam_id}`);
                                    if (statusBox) {
                                        // Append Prediction Info
                                        let currentHtml = statusBox.innerHTML;
                                        // Avoid duplicate appending if interval is fast
                                        if (!currentHtml.includes("Forecast")) {
                                            let forecastColor = "var(--text-muted)";
                                            if (pred.trend.includes("Rising")) forecastColor = "#e67e22";
                                            if (pred.time_to_full.includes("CRITICAL")) forecastColor = "#e74c3c";

                                            statusBox.innerHTML += `
                                                <div style="margin-top:5px; border-top:1px solid rgba(255,255,255,0.1); padding-top:5px;">
                                                    <div style="font-size:0.9em;"><strong>üåä Flow:</strong> ${pred.trend}</div>
                                                    <div style="font-size:0.9em;"><strong>üîÆ Forecast:</strong> <span style="color:${forecastColor}">${pred.time_to_full}</span></div>
                                                </div>
                                             `;
                                        }
                                    }
                                }
                            });

                        let crowdDensityText = 'Low';
                        let densityClass = 'status-safe';
                        if (isHighRiskPresent) {
                            crowdDensityText = 'Critical';
                            densityClass = 'status-stampede';
                        } else if (monitoringZones > 0 && crowdedCount === monitoringZones) {
                            crowdDensityText = 'High';
                            densityClass = 'status-crowded';
                        }

                        document.getElementById('crowd-density-slot').innerHTML = `<span class="${densityClass}">${crowdDensityText}</span>`;
                        document.getElementById('active-alerts-slot').innerText = activeAlerts;
                        document.getElementById('critical-zones-slot').innerText = criticalZones;
                        document.getElementById('monitoring-zones-slot').innerText = monitoringZones;

                        const activeAlertsBar = document.getElementById('active-alerts-bar');
                        if (activeAlerts > 0) activeAlertsBar.classList.add('blinking-alert');
                        else activeAlertsBar.classList.remove('blinking-alert');

                        const criticalZonesBar = document.getElementById('critical-zones-bar');
                        if (criticalZones > 0) criticalZonesBar.classList.add('critical-zone-warning');
                        else criticalZonesBar.classList.remove('critical-zone-warning');

                        // Audio Logic
                        if (audioEnabled && activeAlerts > 0 && !isAlertActive) {
                            alertSound.play().catch(error => console.log("Audio play failed:", error));
                            isAlertActive = true;
                        } else if ((activeAlerts === 0 || !audioEnabled) && isAlertActive) {
                            alertSound.pause();
                            alertSound.currentTime = 0;
                            isAlertActive = false;
                        }

                        // Map Updates
                        for (const zone in zones) {
                            const camId = zoneToCamera[zone];
                            if (all_data[camId]) {
                                setZoneColor(zones[zone], zone, all_data[camId].situation);
                            }
                        }
                    })
                    .catch(error => console.error('Error fetching status data:', error));
            }

            setInterval(updateAllStatuses, 2000);
            updateAllStatuses();
        });
    </script>
</body>

</html>